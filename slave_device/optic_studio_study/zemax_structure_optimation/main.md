# zemax优化
## 快速优化
### 快速调整某一个面的厚度/曲率半径
* 优化-快速调整-调整面（比如0）+参数（比如厚度）-评价：仅X方向光斑-评价面：图像
## 常见像差
### 最后成像存在场曲
* 添加一个平场镜在成像面之前
### 色差
* 双胶合，但是光谱仪不需要这个
## 查看成像质量
### 艾里斑半径对比
* 分析——光线迹点——矩阵点列图——设置——显示艾里斑：勾选——忽略垂轴色差：勾选，图形缩放：可以设置以放大
* 光斑分布越接近艾里斑半径大小越好
### 查看成像密集程度
* 分析——圈入能量——衍射——设置——波长：1，最大距离：10
* 指定半径内圈入的能量越多越好
### 查看分辨率
* 如果需要清晰分辨两个相邻像素，假定两个像素的距离是10微米，满足MTF要大于0.3甚至0.5，截止频率就是1000/2/10微米=50
* 分析——MTF曲线——FFT MTF——设置——波长：1/2/3，最大频率：50
* 查看50处的值是否大于0.3甚至0.5
* 设置相邻波长，点列图(分析——点列图——标准点列图)中相邻波长的能量密集区/能量中心没有交叉或者重合——这里看到的是衍射极限（衍射极限小于像素间距的情况下），还得考虑实际像素间距
* 设置相邻波长，FFT PSF(分析——点扩散函数——FFT PSF)中相邻波长的能量密集区/能量中心没有交叉或者重合——这里看到的是衍射极限（衍射极限小于像素间距的情况下），还得考虑实际像素间距
* 设置相邻波长，惠更斯PSF截面图(分析——点扩散函数——惠更斯PSF截面图——设置——类型：Y-线性，像面采样间距：10微米)中相邻波长的能量密集区/能量中心没有交叉或者重合——这里还能看到实际像素间距的影响
## 评价函数编辑器
### 评估一个面到另一个面的焦距
* 优化——评价函数编辑器——类型：EFLY，面1：m，面2：n——点击左上角更新窗口
### 限定一个面到下一个面的距离
* 两个评价函数组合
* 优化——评价函数编辑器——类型：FTGT，面：n，目标：需要设定的最小值（如果不希望贴合在一起，就设定为0.1），权重：看情况设定
* 优化——评价函数编辑器——类型：FTLT，面：n，目标：需要设定的最大值，权重：看情况设定
### 想添加一个分割线，看起来更规整
* 优化——评价函数编辑器——类型：BLNK
### 限定某个面的后续第m个参数在一定范围内，比如像面歪了，有一个倾斜角
* 两个评价函数组合
* 优化——评价函数编辑器——类型：PMGT，面：n，参数：m（比如坐标中断面的第3个参数是倾斜X），目标：需要设定的最小值，权重：看情况设定
* 优化——评价函数编辑器——类型：PMLT，面：n，参数：m，目标：需要设定的最大值，权重：看情况设定
### 标记自定义优化函数与默认优化函数
* 优化——评价函数编辑器——类型：DMFS
### 限定光线在一定范围内通过
* 优化——评价函数编辑器——类型：REAY
### 对前面单纯取值的操作数操作结果求差
* 优化——评价函数编辑器——类型：DIFF
### 限定前面取值的操作数的范围
* 两个评价函数组合
* 优化——评价函数编辑器——类型：ABGT
* 优化——评价函数编辑器——类型：ABLT
### 执行评价函数中定义的局部优化
* 需要优化的参数的类型改为变量
* 优化——优化向导——成像质量：点列图，忽略垂轴色差：勾选，（X权重：0？？？）——确定（千万不要应用，会被覆盖掉自定义优化函数）
### 执行评价函数中定义的全局优化
* 需要优化的参数的类型改为变量
* 优化——优化向导——全局优化
### 优化圈入能量
* 三个波长的评价函数组合
* 这个作为单独的圈入能量优化，和点列图优化分开
* 优化——评价函数编辑器——类型：DENC，采样：3，波：1，百分比：0.8，类型：3（意思是仅Y方向），参考：1，目标：0，权重：1
* 优化——评价函数编辑器——类型：DENC，采样：3，波：2，百分比：0.8，类型：3，参考：1，目标：0，权重：1
* 优化——评价函数编辑器——类型：DENC，采样：3，波：3，百分比：0.8，类型：3，参考：1，目标：0，权重：1
* 优化——优化向导——全局优化/锤形优化

## 针对交叉c-t结构光谱仪的优化方法
### 优化向导设置
* 优化——优化向导——成像质量：点列图，X权重：0，忽略垂轴色差：勾选，起始行：n——应用——确定
### 光谱中点约束
* 让中间波长的主光线落在探测器上的位置，设置为中间点，作为约束条件，使得光谱长度中心与像面（探测器）中心一致，便于结构设计，采用操作数REAY
* 优化——评价函数编辑器——操作数1——类型：REAY，面：11（对象的像面），波：2（对应的中心波长），权重：1
### 光谱长度$L_{ccd}$约束
* 以最小波长与最大波长的主光线落在探测器上的位置作为光谱起点与终点，两者之间距离即为光谱长度，并作为约束条件，采用操作数REAY，DIFF
* 优化——评价函数编辑器——操作数2——类型：REAY，面：11（对象的像面），波：1（对应的最小波长），权重：0
* 优化——评价函数编辑器——操作数3——类型：REAY，面：11（对象的像面），波：3（对应的最大波长），权重：0
* 优化——评价函数编辑器——操作数4——类型：DIFF，操作数#1：3，操作数#2：2，目标：28.5（对应探测器的长度），权重：1
### 光栅夹角$D_v$约束
* 对于主波长而言，光栅的入射主光线与衍射主光线视角之间的夹角需要固定约束，当把光栅入射角与衍射角设置为变量优化时，这两个变量发生变化容易使光路跑偏，为此需要把这个两角之间夹角固定约束
* 这里需要用到的操作数RAID获取光栅入射角，RAED获取光栅衍射角，而两者之间的夹角通过SUMM来约束，有时需要DIFF获取，具体看两者主光线分布情况，当在光栅面法线同侧时用DIFF，而分布在两侧时用SUMM
* 优化——评价函数编辑器——操作数5——类型：RAID（入射角与法线之间的夹角），面：5（光栅面），波：2（中心波长）
* 优化——评价函数编辑器——操作数6——类型：RAED（入射角与法线之间的夹角），面：5（光栅面），波：2（中心波长）
* 优化——评价函数编辑器——操作数7——类型：SUMM，操作数#1：5，操作数#2：6
* 优化——评价函数编辑器——操作数8——类型：OPGT（ABGT考虑到绝对值，这个没有），操作数#：7，目标：36，权重：1
* 优化——评价函数编辑器——操作数9——类型：OPLT，操作数#：7，目标：40，权重：1
### 距离、角度等其他参数约束
* 入射距离$L_{in}$、出射距离$L_{out}$、入射狭缝到准直镜的距离$d_1$、光栅到汇聚镜的距离$d_2$、准直镜转角$\theta_1$、汇聚镜转角$\theta_2$等参数约束
* 优化——评价函数编辑器——操作数10——类型：FTGT，面：0（光源到准直镜的距离），目标：90，权重：1
* 优化——评价函数编辑器——操作数11——类型：FTLT，面：0（光源到准直镜的距离），目标：100，权重：1
* 优化——评价函数编辑器——操作数12——类型：FTGT，面：3（准直镜到衍射光栅的距离），目标：-80，权重：1
* 优化——评价函数编辑器——操作数13——类型：FTLT，面：3（准直镜到衍射光栅的距离），目标：-70，权重：1
* 优化——评价函数编辑器——操作数14——类型：FTGT，面：6（衍射光栅到汇聚镜的距离），目标：70，权重：1
* 优化——评价函数编辑器——操作数15——类型：FTLT，面：6（衍射光栅到汇聚镜的距离），目标：75，权重：1
* 优化——评价函数编辑器——操作数16——类型：FTGT，面：6（汇聚镜到像面的距离），目标：-110，权重：1
* 优化——评价函数编辑器——操作数17——类型：FTLT，面：6（汇聚镜到像面的距离），目标：-90，权重：1
* 优化——评价函数编辑器——操作数18——类型：PMGT，面：1，参数：3（设置准直镜转角），目标：9，权重：1
* 优化——评价函数编辑器——操作数19——类型：PMLT，面：1，参数：3（设置准直镜转角），目标：12，权重：1
* 优化——评价函数编辑器——操作数20——类型：PMGT，面：7，参数：3（设置汇聚镜转角），目标：11，权重：1
* 优化——评价函数编辑器——操作数21——类型：PMLT，面：7，参数：3（设置汇聚镜转角），目标：14，权重：1
* 优化——评价函数编辑器——操作数22——类型：PMGT，面：10，参数：3（设置像面转角），目标：-6，权重：1
* 优化——评价函数编辑器——操作数23——类型：PMLT，面：10，参数：3（设置像面转角），目标：-3，权重：1
* 其他设置：
    * 设定为变量
        * 曲率半径：
            * 面2：准直镜
            * 面8：汇聚镜
        * 厚度：
            * 面0：物面到准直镜的距离
            * 面3：准直镜到光栅的距离
            * 面9：光栅到像面的距离
        * 倾斜X：
            * 面1：准直镜转角
            * 面4：光栅入射角
            * 面6：光栅衍射角
            * 面7：汇聚镜转角
            * 面10：像面转角
    * 设定为拾取
        * 厚度：
            * 面6：光栅到汇聚镜的距离
                * 从表面：3（准直镜到光栅的距离），缩放因子：-1
        * 倾斜X：
            * 面3：对应面1准直镜转角
                * 从表面：1,缩放因子：1
            * 面9：对应面7汇聚镜转角
                * 从表面：1,缩放因子：1

### 光谱分辨率的计算
#### 波长的线色散计算
* 从该波长$\lambda_1$到波长$\lambda_2$变化了$d\lambda$，而照射在探测器上距离变化量为$dL$，那么该波长的线色散$=\frac{d\lambda}{dL}$
* 由于c-t光谱仪的各个波长线色散一致性良好，所以可采用使用波长范围除以探测器长度即$\frac{\lambda_2-\lambda_1}{L_{CCD}}=\frac{d\lambda}{dL}$，这是一种简单近似方式计算波长的线色散
* 另外一种更为精确的方式是利用Zemax的Merit Function Editor中操作数REAY，从波长$\lambda_1$到$\lambda_2$探测器的位置分别用REAY获得并用DIFF获得距离变化量$dl$，这里$\lambda_1$到$\lambda_2$间隔10nm
#### 衍射极限的计算
* 衍射极限公式：$1.22*\lambda*F\#$，其中$\lambda$是使用波长，$F\#$是像空间的工作F数，Zemax中像空间的工作$F$数与$NA$的关系：$F\#=\frac{1}{2NA}$，而$NA=nsin(\theta)$，$\theta$是像空间某波长的边缘光线与主光线之间的夹角
* 可以利用Zemax的Merit Function Editor中优化操作数RAID获得探测器前的某波长的边缘光线与主光线之间夹角。但往往两侧边缘光线与主光线之间的夹角不相等，所以两侧夹角求和再平均获得$\theta$，最后得到某波长的$F\#$
#### zemax线色散计算操作
* 优化——评价函数编辑器——操作数2——类型：REAY，面：11（像面），波：1
* 优化——评价函数编辑器——操作数3——类型：REAY，面：11（像面），波：2
* 优化——评价函数编辑器——操作数4——类型：DIFF，操作数#1：3，操作数#1：2，权重：1
* 优化——评价函数编辑器——操作数5——类型：CONS，目标：0.01
* 优化——评价函数编辑器——操作数6——类型：DIVI，操作数#1：5，操作数#1：4
#### zemax $F\#$ 的计算
* 优化——评价函数编辑器——操作数8——类型：RAID，面：11，波：1，Py：-1
* 优化——评价函数编辑器——操作数9——类型：RAID，面：11，波：1，Py：1
* 优化——评价函数编辑器——操作数10——类型：SUMM，操作数#1：8，操作数#1：9
* 优化——评价函数编辑器——操作数11——类型：CONS，目标：2
* 优化——评价函数编辑器——操作数12——类型：DIVI，操作数#1：10，操作数#1：11
* 优化——评价函数编辑器——操作数13——类型：SINE，操作数#：12，Flag：1（按角度来）
* 优化——评价函数编辑器——操作数14——类型：CONS，目标：0.5
* 优化——评价函数编辑器——操作数15——类型：DIVI，操作数#1：14，操作数#1：13
#### zemax衍射极限的计算
* 优化——评价函数编辑器——操作数17——类型：CONS，目标：1.22
* 优化——评价函数编辑器——操作数18——类型：WLEN（引用某个波长），波长：1
* 优化——评价函数编辑器——操作数19——类型：PROD（相乘），操作数#1：15，操作数#1：17
* 优化——评价函数编辑器——操作数20——类型：PROD，操作数#1：18，操作数#1：19

